<!DOCTYPE html>
<html>
<body>
<script type="module">
    import { Fd } from "./bjorn3_browser_wasi_shim/fd.js";
    import { File, Directory } from "./bjorn3_browser_wasi_shim/fs_core.js";
    import { PreopenDirectory, OpenFile } from "./bjorn3_browser_wasi_shim/fs_fd.js";
    import WASI from "./bjorn3_browser_wasi_shim/wasi.js";

    (async () => {
        let args = ["bin", "2022-08-27", "table", "34.23,23.3,0", "100"];
        let env = ["FOO=bar"];
        let fds = [
            new OpenFile(new File([])), // stdin
            new OpenFile(new File([])), // stdout
            new OpenFile(new File([])), // stderr
            new PreopenDirectory(".", {
                "example.c": new File(new TextEncoder("utf-8").encode(`#include "a"`)),
                "hello.rs": new File(new TextEncoder("utf-8").encode(`fn main() { println!("Hello World!"); }`)),
            }),
        ];
        let wasi = new WASI(args, env, fds);

        let wasm = await WebAssembly.compileStreaming(fetch("index.wasm"));
        let inst = await WebAssembly.instantiate(wasm, {
            "wasi_snapshot_preview1": wasi.wasiImport,
        });
        try { wasi.start(inst); } catch (_) {} // exit is ok
        alert(new TextDecoder("utf-8").decode(fds[1].file.data));
    })();

    (async () => {
        let args = ["bin", "2022-08-27", "map", "evening", "yallop", "out.png"];
        let env = ["FOO=bar"];
        let fds = [
            new OpenFile(new File([])), // stdin
            new OpenFile(new File([])), // stdout
            new OpenFile(new File([])), // stderr
            new PreopenDirectory("/", {
                "out.png": new File([]),
            }),
        ];
        let wasi = new WASI(args, env, fds);

        let wasm = await WebAssembly.compileStreaming(fetch("index.wasm"));
        let inst = await WebAssembly.instantiate(wasm, {
            "wasi_snapshot_preview1": wasi.wasiImport,
        });
        console.log('wait');
        try { wasi.start(inst); } catch (e) { console.error(e); } // exit is ok
        console.log('finished');

        // https://stackoverflow.com/a/66046176
        async function bufferToBase64(buffer) {
            // use a FileReader to generate a base64 data URI:
            const base64url = await new Promise(r => {
                const reader = new FileReader()
                reader.onload = () => r(reader.result)
                reader.readAsDataURL(new Blob([buffer]))
            });
            // remove the `data:...;base64,` part from the start
            return base64url.slice(base64url.indexOf(',') + 1);
        }

        const result = await bufferToBase64(fds[1].file.data);
        document.write('<img src="map.png" width=360 height=180 style="position: absolute;">');
        document.write('<img src="data:image/png;base64,' + result + '" style="position: absolute;">');
    })();
</script>
</body>
</html>
